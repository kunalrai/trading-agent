{% extends "base.html" %}

{% block title %}SolSignals - Settings{% endblock %}

{% block content %}
<main class="flex-grow p-10 space-y-8">
    <div class="flex flex-wrap justify-between gap-3 p-4">
        <div class="flex min-w-72 flex-col gap-3">
            <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Settings</p>
            <p class="text-white/70 text-base font-normal leading-normal">Customize your crypto breakout scanning experience</p>
        </div>
    </div>
    
    <!-- Scanning Parameters -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Scanning Parameters</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Breakout Threshold</label>
                <div class="flex items-center gap-4">
                    <span class="text-primary font-bold">5%</span>
                    <input class="w-48 h-2 bg-[#283339] rounded-lg appearance-none cursor-pointer accent-primary" max="20" min="1" type="range" value="5" title="Breakout Threshold"/>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Timeframe for Analysis</label>
                <div class="flex gap-2">
                    <button class="px-4 py-2 rounded-lg bg-[#283339] text-white/80 hover:bg-primary hover:text-white text-sm font-medium">1h</button>
                    <button class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium">4h</button>
                    <button class="px-4 py-2 rounded-lg bg-[#283339] text-white/80 hover:bg-primary hover:text-white text-sm font-medium">1d</button>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Volume Increase Threshold</label>
                <div class="flex items-center gap-4">
                    <span class="text-primary font-bold">150%</span>
                    <input class="w-48 h-2 bg-[#283339] rounded-lg appearance-none cursor-pointer accent-primary" max="500" min="50" step="10" type="range" value="150" title="Volume Increase Threshold"/>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Technical Indicators -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Technical Indicators</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-6 grid grid-cols-2 gap-6">
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">RSI (Relative Strength Index)</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input checked="" class="sr-only peer" type="checkbox" value="" title="Enable RSI"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">MACD (Moving Average Convergence Divergence)</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input checked="" class="sr-only peer" type="checkbox" value="" title="Enable MACD"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Bollinger Bands</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input class="sr-only peer" type="checkbox" value="" title="Enable Bollinger Bands"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Stochastic Oscillator</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input class="sr-only peer" type="checkbox" value="" title="Enable Stochastic Oscillator"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
        </div>
    </section>
    
    <!-- Notifications -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Notifications</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Email Notifications</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input checked="" class="sr-only peer" type="checkbox" value="" title="Enable Email Notifications"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <input class="w-full bg-[#283339] border-none rounded-lg text-white px-4 py-3 focus:ring-2 focus:ring-primary" placeholder="your.email@example.com" type="email"/>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Desktop Push Notifications</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input class="sr-only peer" type="checkbox" value="" title="Enable Desktop Notifications"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <label class="text-white text-base font-normal leading-normal">Mobile Push Notifications</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input checked="" class="sr-only peer" type="checkbox" value="" title="Enable Mobile Notifications"/>
                    <div class="w-11 h-6 bg-[#283339] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
        </div>
    </section>
    
    <!-- Watchlist Management -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Watchlist Management</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-6 space-y-4">
            <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/50">search</span>
                <input class="w-full bg-[#283339] border-none rounded-lg text-white pl-10 pr-4 py-3 focus:ring-2 focus:ring-primary" placeholder="Search from Top 50 cryptocurrencies..." type="text"/>
            </div>
            <div class="flex flex-wrap gap-3">
                <span class="flex items-center gap-2 bg-primary/20 text-primary px-3 py-1 rounded-full text-sm font-medium">Bitcoin (BTC) <button class="text-primary/70 hover:text-primary">×</button></span>
                <span class="flex items-center gap-2 bg-primary/20 text-primary px-3 py-1 rounded-full text-sm font-medium">Ethereum (ETH) <button class="text-primary/70 hover:text-primary">×</button></span>
                <span class="flex items-center gap-2 bg-primary/20 text-primary px-3 py-1 rounded-full text-sm font-medium">Cardano (ADA) <button class="text-primary/70 hover:text-primary">×</button></span>
                <span class="flex items-center gap-2 bg-primary/20 text-primary px-3 py-1 rounded-full text-sm font-medium">Solana (SOL) <button class="text-primary/70 hover:text-primary">×</button></span>
            </div>
        </div>
    </section>
    
    <div class="flex justify-end items-center gap-4 pt-8 pb-4 sticky bottom-0 bg-background-dark/80 backdrop-blur-sm px-4">
        <button class="text-white/70 hover:text-white text-sm font-medium">Reset to Default</button>
        <button class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
            <span class="truncate">Save Changes</span>
        </button>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
// Settings page specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load current settings from server
    loadCurrentSettings();
    
    // Handle timeframe button clicks
    setupTimeframeButtons();
    
    // Handle settings form
    let saveButton = null;
    
    // Find save button by text content (since :contains() is not valid CSS)
    const buttons = document.querySelectorAll('button');
    for (let btn of buttons) {
        if (btn.textContent.trim() === 'Save Changes') {
            saveButton = btn;
            break;
        }
    }
    
    if (saveButton) {
        saveButton.addEventListener('click', function() {
            saveSettings();
        });
    }
    
    // Handle range input updates
    document.querySelectorAll('input[type="range"]').forEach((range, index) => {
        console.log(`Setting up range slider ${index + 1}:`, {
            max: range.max,
            min: range.min,
            value: range.value,
            title: range.title
        });
        
        const updateDisplay = () => {
            const value = range.value;
            console.log(`Range slider ${index + 1} value changed to: ${value}`);
            
            // Look for the span in the same parent container
            const parentDiv = range.parentElement;
            const span = parentDiv.querySelector('span.text-primary');
            
            console.log(`Looking for span in parent:`, {
                parentElement: parentDiv.tagName,
                spanFound: !!span
            });
            
            if (span) {
                if (range.max === "20") {
                    span.textContent = value + '%';
                    console.log(`Updated breakout threshold display to: ${value}%`);
                } else if (range.max === "500") {
                    span.textContent = value + '%';
                    console.log(`Updated volume threshold display to: ${value}%`);
                }
            } else {
                // Fallback: look for span in the grandparent (the flex container)
                const grandParent = range.parentElement.parentElement;
                console.log(`Fallback: looking in grandparent:`, {
                    grandParentElement: grandParent ? grandParent.tagName : 'null'
                });
                
                if (grandParent) {
                    const fallbackSpan = grandParent.querySelector('span.text-primary');
                    console.log(`Fallback span found:`, !!fallbackSpan);
                    
                    if (fallbackSpan) {
                        if (range.max === "20") {
                            fallbackSpan.textContent = value + '%';
                            console.log(`Updated breakout threshold display (fallback) to: ${value}%`);
                        } else if (range.max === "500") {
                            fallbackSpan.textContent = value + '%';
                            console.log(`Updated volume threshold display (fallback) to: ${value}%`);
                        }
                    } else {
                        console.error(`Could not find span element for range slider ${index + 1}`);
                    }
                }
            }
        };
        
        range.addEventListener('input', updateDisplay);
        range.addEventListener('change', updateDisplay); // Also handle change event
        updateDisplay(); // Initial update
        
        console.log(`Range slider ${index + 1} setup complete`);
    });
    
    // Handle watchlist management
    document.querySelectorAll('.bg-primary\\/20 button').forEach(button => {
        button.addEventListener('click', function() {
            this.parentElement.remove();
            SolSignals.utils.showNotification('Removed from watchlist', 'info');
        });
    });
});

function setupTimeframeButtons() {
    // Get all timeframe buttons
    const timeframeButtons = document.querySelectorAll('.flex.gap-2 button');
    
    timeframeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active state from all buttons
            timeframeButtons.forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-[#283339]', 'text-white/80');
            });
            
            // Add active state to clicked button
            this.classList.remove('bg-[#283339]', 'text-white/80');
            this.classList.add('bg-primary', 'text-white');
        });
    });
}

function loadCurrentSettings() {
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                applySettingsToForm(data.settings);
            } else {
                console.error('Failed to load settings:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

function applySettingsToForm(settings) {
    // Apply scanning parameters
    if (settings.scanning) {
        const breakoutRange = document.querySelector('input[max="20"]');
        if (breakoutRange && settings.scanning.breakout_threshold !== undefined) {
            breakoutRange.value = settings.scanning.breakout_threshold;
            breakoutRange.dispatchEvent(new Event('input'));
        }
        
        const volumeRange = document.querySelector('input[max="500"]');
        if (volumeRange && settings.scanning.volume_threshold !== undefined) {
            volumeRange.value = settings.scanning.volume_threshold;
            volumeRange.dispatchEvent(new Event('input'));
        }
        
        // Handle timeframe buttons
        if (settings.scanning.timeframe) {
            const timeframeButtons = document.querySelectorAll('.flex.gap-2 button');
            timeframeButtons.forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-[#283339]', 'text-white/80');
                if (btn.textContent.trim() === settings.scanning.timeframe) {
                    btn.classList.remove('bg-[#283339]', 'text-white/80');
                    btn.classList.add('bg-primary', 'text-white');
                }
            });
        }
    }
    
    // Apply indicator settings
    if (settings.indicators) {
        const rsiToggle = document.querySelector('input[title="Enable RSI"]');
        if (rsiToggle) rsiToggle.checked = settings.indicators.rsi_enabled || false;
        
        const macdToggle = document.querySelector('input[title="Enable MACD"]');
        if (macdToggle) macdToggle.checked = settings.indicators.macd_enabled || false;
        
        const bollingerToggle = document.querySelector('input[title="Enable Bollinger Bands"]');
        if (bollingerToggle) bollingerToggle.checked = settings.indicators.bollinger_bands_enabled || false;
        
        const stochasticToggle = document.querySelector('input[title="Enable Stochastic Oscillator"]');
        if (stochasticToggle) stochasticToggle.checked = settings.indicators.stochastic_enabled || false;
    }
    
    // Apply notification settings
    if (settings.notifications) {
        const emailToggle = document.querySelector('input[title="Enable Email Notifications"]');
        if (emailToggle) emailToggle.checked = settings.notifications.email_notifications || false;
        
        const desktopToggle = document.querySelector('input[title="Enable Desktop Notifications"]');
        if (desktopToggle) desktopToggle.checked = settings.notifications.desktop_notifications || false;
        
        const mobileToggle = document.querySelector('input[title="Enable Mobile Notifications"]');
        if (mobileToggle) mobileToggle.checked = settings.notifications.mobile_notifications || false;
        
        const emailInput = document.querySelector('input[type="email"]');
        if (emailInput && settings.notifications.notification_email) {
            emailInput.value = settings.notifications.notification_email;
        }
    }
}

function getSelectedTimeframe() {
    const timeframeButtons = document.querySelectorAll('.flex.gap-2 button');
    for (let btn of timeframeButtons) {
        if (btn.classList.contains('bg-primary')) {
            return btn.textContent.trim();
        }
    }
    return '4h'; // default fallback
}

function saveSettings() {
    // Collect all settings
    const settings = {
        breakoutThreshold: document.querySelector('input[max="20"]').value,
        volumeThreshold: document.querySelector('input[max="500"]').value,
        timeframe: getSelectedTimeframe(),
        indicators: {
            rsi: document.querySelector('input[title="Enable RSI"]').checked,
            macd: document.querySelector('input[title="Enable MACD"]').checked,
            bollingerBands: document.querySelector('input[title="Enable Bollinger Bands"]').checked,
            stochastic: document.querySelector('input[title="Enable Stochastic Oscillator"]').checked
        },
        notifications: {
            email: document.querySelector('input[title="Enable Email Notifications"]').checked,
            desktop: document.querySelector('input[title="Enable Desktop Notifications"]').checked,
            mobile: document.querySelector('input[title="Enable Mobile Notifications"]').checked
        },
        emailAddress: document.querySelector('input[type="email"]').value
    };
    
    console.log('Saving settings:', settings);
    
    // Show loading state
    const saveButtons = document.querySelectorAll('button');
    let saveButton = null;
    for (let btn of saveButtons) {
        if (btn.textContent.trim() === 'Save Changes') {
            saveButton = btn;
            break;
        }
    }
    
    if (saveButton) {
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;
        
        // Send to server
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                SolSignals.utils.showNotification('Settings saved successfully!', 'success');
            } else {
                SolSignals.utils.showNotification('Failed to save settings: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving settings:', error);
            SolSignals.utils.showNotification('Error saving settings: ' + error.message, 'error');
        })
        .finally(() => {
            // Restore button state
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        });
    }
}
</script>
{% endblock %}