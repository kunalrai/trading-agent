<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SolSignals - Coin Scanner</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13a4ec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
</head>
<body>
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden font-display">
    <div class="layout-container flex h-full grow flex-col">
        
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-white/10 px-10 py-3">
            <div class="flex items-center gap-4 text-white">
                <div class="w-8 h-8 text-primary">
                    <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em]">SolSignals</h2>
            </div>
            
            <div class="flex flex-1 justify-end gap-8">
                <div class="flex items-center gap-9">
                    {% include 'navigation.html' %}
                </div>
                <div class="flex items-center gap-4">
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-white/5 hover:bg-white/10 text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                        <span class="material-symbols-outlined text-white text-xl">account_circle</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-white text-sm font-medium">CoinDCX</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-10 py-5">
            <div class="flex flex-col max-w-[1400px] mx-auto flex-1">
                
                <!-- Scanner Header -->
                <div class="mb-6 bg-white/5 border border-white/10 rounded-lg p-6">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white mb-2">Cryptocurrency Scanner</h1>
                            <p class="text-white/70">Real-time monitoring of 378 USDT futures with EMA50 analysis</p>
                        </div>
                        
                        <!-- Statistics and Controls -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <!-- Data Statistics -->
                            <div class="bg-blue-500/20 rounded-lg p-4 text-center min-w-48">
                                <div class="text-sm text-blue-300 mb-1">Database Status</div>
                                <div id="stats-total" class="text-lg font-semibold text-white">Loading...</div>
                                <div id="stats-updated" class="text-xs text-blue-300">Last updated: ...</div>
                            </div>
                            
                            <!-- Refresh Button -->
                            <button id="refreshBtn" class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span id="refreshBtnText">Refresh Data</span>
                                <span id="refreshBtnSpinner" class="hidden">
                                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Refreshing...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="bg-white/5 border border-white/10 rounded-lg p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <!-- Search -->
                        <div class="flex-1">
                            <input type="text" id="searchInput" placeholder="Search by symbol (e.g., BTC, ETH, SOL)" 
                                class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-white/50 focus:outline-none focus:border-primary">
                        </div>
                        
                        <!-- Sort Controls -->
                        <div class="flex gap-2">
                            <select id="sortBy" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-green-400">
                                <option value="symbol">Sort by Symbol</option>
                                <option value="current_price">Sort by Price</option>
                                <option value="ema_50">Sort by EMA50</option>
                                <option value="price_diff">Sort by Difference</option>
                                <option value="diff_percentage">Sort by % Diff</option>
                                <option value="volume_24h">Sort by Volume</option>
                            </select>
                            
                            <select id="sortOrder" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-green-400">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        
                        <!-- Trend Filter -->
                        <select id="trendFilter" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-green-400">
                            <option value="">All Trends</option>
                            <option value="bullish">Bullish Only</option>
                            <option value="bearish">Bearish Only</option>
                        </select>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-white/10">
                                <tr>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">
                                        Symbol 
                                        <span class="text-xs text-white/50 block">Click to view chart</span>
                                    </th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">Current Price</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">EMA50</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">Difference</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">% Diff</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">Volume 24h</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">Trend</th>
                                    <th class="text-left text-white/70 text-sm font-medium py-4 px-6">Updated</th>
                                </tr>
                            </thead>
                            <tbody id="coinsTableBody">
                                <!-- Loading State -->
                                <tr>
                                    <td colspan="8" class="text-center py-12 text-white/60">
                                        <div class="flex flex-col items-center space-y-4">
                                            <div class="animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full"></div>
                                            <div>Loading coin data...</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-6">
                    <div class="text-white/70 text-sm">
                        Showing <span id="currentResults">0</span> of <span id="totalResults">0</span> coins
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="prevPage" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Previous
                        </button>
                        <span id="pageInfo" class="flex items-center px-4 py-2 text-white/70">Page 1</span>
                        <button id="nextPage" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
// State management
let currentPage = 1;
const pageSize = 50;
let totalCoins = 0;
let allCoins = [];
let filteredCoins = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDataStatistics();
    loadCoinsData();
    setupEventListeners();
});

// Load database statistics
async function loadDataStatistics() {
    try {
        const response = await fetch('/api/coin-data-stats');
        const data = await response.json();
        
        if (data.status === 'success') {
            const stats = data.statistics;
            document.getElementById('stats-total').textContent = `${stats.total_coins} coins`;
            if (stats.last_updated) {
                const lastUpdated = new Date(stats.last_updated);
                document.getElementById('stats-updated').textContent = `Last updated: ${lastUpdated.toLocaleString()}`;
            }
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('stats-total').textContent = 'Error loading stats';
    }
}

// Load coins data
async function loadCoinsData() {
    try {
        showLoading();
        
        const response = await fetch('/api/all-coins-data');
        const data = await response.json();
        
        if (data.status === 'success') {
            allCoins = data.coins;
            totalCoins = allCoins.length;
            
            // Apply current filters
            applyFilters();
            
            console.log(`Loaded ${totalCoins} coins from database`);
        } else {
            throw new Error(data.error || 'Failed to load coins data');
        }
    } catch (error) {
        console.error('Error loading coins data:', error);
        showError('Failed to load coins data. Please try refreshing.');
    }
}

// Apply search and filters
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const trendFilter = document.getElementById('trendFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    // Filter coins
    filteredCoins = allCoins.filter(coin => {
        const matchesSearch = !searchTerm || coin.symbol.toLowerCase().includes(searchTerm);
        const matchesTrend = !trendFilter || coin.trend === trendFilter;
        return matchesSearch && matchesTrend;
    });
    
    // Sort coins
    filteredCoins.sort((a, b) => {
        let valueA = a[sortBy];
        let valueB = b[sortBy];
        
        // Handle numeric vs string comparison
        if (typeof valueA === 'string' && typeof valueB === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
        }
        
        if (sortOrder === 'desc') {
            return valueB > valueA ? 1 : -1;
        } else {
            return valueA > valueB ? 1 : -1;
        }
    });
    
    // Reset to first page
    currentPage = 1;
    displayCoins();
    updatePagination();
}

// Display coins for current page
function displayCoins() {
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredCoins.length);
    const coinsToShow = filteredCoins.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('coinsTableBody');
    
    if (coinsToShow.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-12 text-white/60">
                    No coins found matching your criteria.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = coinsToShow.map(coin => {
        const trendColor = coin.trend === 'bullish' ? 'text-green-400' : 'text-red-400';
        const trendIcon = coin.trend === 'bullish' ? '↗' : '↘';
        const diffColor = coin.price_diff >= 0 ? 'text-green-400' : 'text-red-400';
        const diffSign = coin.price_diff >= 0 ? '+' : '';
        
        const updatedTime = coin.last_updated ? new Date(coin.last_updated).toLocaleTimeString() : 'N/A';
        
        // Create CoinDCX futures chart link
        const chartUrl = coin.futures_symbol ? `https://coindcx.com/futures/${coin.futures_symbol}` : '#';
        
        return `
            <tr class="border-b border-white/5 hover:bg-white/5">
                <td class="py-4 px-6">
                    <div class="flex flex-col">
                        <a href="${chartUrl}" target="_blank" rel="noopener noreferrer" 
                           class="font-medium text-white hover:text-primary transition-colors inline-flex items-center group">
                            ${coin.symbol}
                            <svg class="w-3 h-3 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </a>
                        <div class="text-xs text-white/50">${coin.futures_symbol || ''}</div>
                    </div>
                </td>
                <td class="py-4 px-6 text-white font-mono">$${formatPrice(coin.current_price)}</td>
                <td class="py-4 px-6 text-white/80 font-mono">$${formatPrice(coin.ema_50)}</td>
                <td class="py-4 px-6 ${diffColor} font-mono">${diffSign}$${formatPrice(Math.abs(coin.price_diff))}</td>
                <td class="py-4 px-6 ${diffColor} font-mono">${diffSign}${coin.diff_percentage.toFixed(2)}%</td>
                <td class="py-4 px-6 text-white/80 font-mono">${formatVolume(coin.volume_24h)}</td>
                <td class="py-4 px-6">
                    <span class="${trendColor} text-sm font-medium">
                        ${trendIcon} ${coin.trend.charAt(0).toUpperCase() + coin.trend.slice(1)}
                    </span>
                </td>
                <td class="py-4 px-6 text-white/60 text-sm">${updatedTime}</td>
            </tr>
        `;
    }).join('');
    
    // Update results counter
    document.getElementById('currentResults').textContent = filteredCoins.length;
    document.getElementById('totalResults').textContent = totalCoins;
}

// Update pagination controls
function updatePagination() {
    const totalPages = Math.ceil(filteredCoins.length / pageSize);
    
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}

// Setup event listeners
function setupEventListeners() {
    // Search input
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
    });
    
    // Sort controls
    document.getElementById('sortBy').addEventListener('change', applyFilters);
    document.getElementById('sortOrder').addEventListener('change', applyFilters);
    document.getElementById('trendFilter').addEventListener('change', applyFilters);
    
    // Pagination
    document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            displayCoins();
            updatePagination();
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', function() {
        const totalPages = Math.ceil(filteredCoins.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            displayCoins();
            updatePagination();
        }
    });
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', forceRefresh);
}

// Force refresh data
async function forceRefresh() {
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshBtnText = document.getElementById('refreshBtnText');
    const refreshBtnSpinner = document.getElementById('refreshBtnSpinner');
    
    refreshBtn.disabled = true;
    refreshBtnText.classList.add('hidden');
    refreshBtnSpinner.classList.remove('hidden');
    
    try {
        // Trigger background refresh
        const refreshResponse = await fetch('/api/force-coin-data-refresh', { method: 'POST' });
        const refreshData = await refreshResponse.json();
        
        if (refreshData.status === 'success') {
            // Wait a moment for refresh to start
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Reload data and statistics
            await Promise.all([
                loadDataStatistics(),
                loadCoinsData()
            ]);
        } else {
            throw new Error(refreshData.error || 'Failed to refresh data');
        }
    } catch (error) {
        console.error('Error refreshing data:', error);
        showError('Failed to refresh data. Please try again.');
    } finally {
        refreshBtn.disabled = false;
        refreshBtnText.classList.remove('hidden');
        refreshBtnSpinner.classList.add('hidden');
    }
}

// Utility functions
function formatPrice(price) {
    if (price >= 1) {
        return price.toFixed(4);
    } else {
        return price.toFixed(8);
    }
}

function formatVolume(volume) {
    if (volume >= 1e9) {
        return (volume / 1e9).toFixed(2) + 'B';
    } else if (volume >= 1e6) {
        return (volume / 1e6).toFixed(2) + 'M';
    } else if (volume >= 1e3) {
        return (volume / 1e3).toFixed(2) + 'K';
    } else {
        return volume.toFixed(2);
    }
}

function showLoading() {
    document.getElementById('coinsTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-12 text-white/60">
                <div class="flex flex-col items-center space-y-4">
                    <div class="animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full"></div>
                    <div>Loading coin data...</div>
                </div>
            </td>
        </tr>
    `;
}

function showError(message) {
    document.getElementById('coinsTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-12 text-red-400">
                <div class="flex flex-col items-center space-y-4">
                    <span class="material-symbols-outlined text-4xl">error</span>
                    <div>${message}</div>
                </div>
            </td>
        </tr>
    `;
}

// Auto-refresh every 2 minutes
setInterval(loadDataStatistics, 120000);
</script>

</body>
</html>