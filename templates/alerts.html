{% extends "base.html" %}

{% block title %}SolSignals - Alerts{% endblock %}

{% block content %}
<main class="flex-grow p-10 space-y-8">
    <div class="flex flex-wrap justify-between items-center gap-4">
        <div class="flex flex-col gap-2">
            <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Alerts</p>
            <p class="text-white/70 text-base font-normal leading-normal">Create and manage your custom trading alerts</p>
        </div>
        <button id="createAlertBtn" class="flex items-center justify-center gap-2 min-w-[120px] max-w-[480px] cursor-pointer overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
            <span class="material-symbols-outlined">add</span>
            <span class="truncate">Create Alert</span>
        </button>
    </div>

    <!-- Create Alert Section -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Create a New Alert</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Cryptocurrency</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-white/50">search</span>
                        <input id="coinSearch" class="w-full bg-[#283339] border-none rounded-lg text-white pl-10 pr-4 py-3 focus:ring-2 focus:ring-primary" placeholder="Search for a coin (e.g. BTC, ETH, SOL)" type="text"/>
                    </div>
                </div>
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Alert Condition</label>
                    <select id="alertCondition" class="w-full bg-[#283339] border-none rounded-lg text-white px-4 py-3 focus:ring-2 focus:ring-primary">
                        <option value="price_crosses_ema">Price crosses EMA</option>
                        <option value="price_above_ema">Price above EMA</option>
                        <option value="price_below_ema">Price below EMA</option>
                        <option value="volume_spike">Volume spike</option>
                        <option value="breakout_detected">Breakout detected</option>
                        <option value="rsi_oversold">RSI oversold (&lt; 30)</option>
                        <option value="rsi_overbought">RSI overbought (&gt; 70)</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-white/80 text-sm font-medium mb-2">Threshold Value</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-white/50">$</span>
                    <input id="thresholdValue" class="w-full bg-[#283339] border-none rounded-lg text-white pl-8 pr-4 py-3 focus:ring-2 focus:ring-primary" placeholder="Enter threshold value (e.g. 5.0 for $5 distance)" type="number" step="0.01"/>
                </div>
                <p class="text-white/50 text-xs mt-1">For price alerts: dollar amount. For volume: percentage increase (e.g. 150 for 150%)</p>
            </div>
            <div>
                <label class="block text-white/80 text-sm font-medium mb-2">Notification Methods</label>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="notifyInApp" checked class="h-5 w-5 rounded bg-[#283339] border-none text-primary focus:ring-primary" type="checkbox"/>
                        <span class="text-white">In-app notification</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="notifyEmail" class="h-5 w-5 rounded bg-[#283339] border-none text-primary focus:ring-primary" type="checkbox"/>
                        <span class="text-white">Email notification</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input id="notifyPush" class="h-5 w-5 rounded bg-[#283339] border-none text-primary focus:ring-primary" type="checkbox"/>
                        <span class="text-white">Push notification</span>
                    </label>
                </div>
            </div>
            <div class="flex justify-end pt-4">
                <button id="addAlertBtn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
                    <span class="truncate">Add Alert</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Active Alerts Section -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Active Alerts</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-2">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-white/60 text-sm font-medium border-b border-[#283339]">
                            <th class="p-4">Coin</th>
                            <th class="p-4">Condition</th>
                            <th class="p-4">Threshold</th>
                            <th class="p-4">Notifications</th>
                            <th class="p-4">Created</th>
                            <th class="p-4">Status</th>
                            <th class="p-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activeAlertsTable">
                        <!-- Active alerts will be populated here -->
                    </tbody>
                </table>
            </div>
            <div id="noActiveAlerts" class="text-center py-8 text-white/60">
                <span class="material-symbols-outlined text-4xl mb-2 block opacity-50">notifications_off</span>
                <p>No active alerts. Create your first alert above.</p>
            </div>
        </div>
    </section>

    <!-- Alert History Section -->
    <section class="space-y-4">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Alert History</h2>
        <div class="rounded-xl bg-[#1a1a1a]/60 p-2">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-white/60 text-sm font-medium border-b border-[#283339]">
                            <th class="p-4">Coin</th>
                            <th class="p-4">Condition Triggered</th>
                            <th class="p-4">Triggered At</th>
                            <th class="p-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="alertHistoryTable">
                        <!-- Alert history will be populated here -->
                    </tbody>
                </table>
            </div>
            <div id="noAlertHistory" class="text-center py-8 text-white/60">
                <span class="material-symbols-outlined text-4xl mb-2 block opacity-50">history</span>
                <p>No alert history yet.</p>
            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block scripts %}
<script>
// Alerts page specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadActiveAlerts();
    loadAlertHistory();
    
    // Handle create alert button
    const addAlertBtn = document.getElementById('addAlertBtn');
    if (addAlertBtn) {
        addAlertBtn.addEventListener('click', function() {
            createAlert();
        });
    }
    
    // Handle coin search with suggestions
    const coinSearch = document.getElementById('coinSearch');
    if (coinSearch) {
        coinSearch.addEventListener('input', function() {
            // TODO: Add coin search suggestions
        });
    }
});

function loadActiveAlerts() {
    fetch('/api/alerts/active')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayActiveAlerts(data.alerts);
            } else {
                console.error('Failed to load active alerts:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading active alerts:', error);
        });
}

function loadAlertHistory() {
    fetch('/api/alerts/history')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAlertHistory(data.history);
            } else {
                console.error('Failed to load alert history:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading alert history:', error);
        });
}

function displayActiveAlerts(alerts) {
    const tableBody = document.getElementById('activeAlertsTable');
    const noAlertsDiv = document.getElementById('noActiveAlerts');
    
    if (alerts && alerts.length > 0) {
        tableBody.style.display = '';
        noAlertsDiv.style.display = 'none';
        
        tableBody.innerHTML = alerts.map(alert => `
            <tr class="border-b border-[#283339] hover:bg-[#283339]/50">
                <td class="p-4 font-medium">${alert.symbol}</td>
                <td class="p-4">${formatCondition(alert.condition_type)}</td>
                <td class="p-4">${formatThreshold(alert.threshold_value, alert.condition_type)}</td>
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        ${getNotificationIcons(alert.notification_method)}
                    </div>
                </td>
                <td class="p-4 text-white/70">${formatDate(alert.created_at)}</td>
                <td class="p-4">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${alert.is_active ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                        ${alert.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleAlert(${alert.id})" class="text-white/70 hover:text-white" title="Toggle">
                            <span class="material-symbols-outlined text-lg">${alert.is_active ? 'pause' : 'play_arrow'}</span>
                        </button>
                        <button onclick="deleteAlert(${alert.id})" class="text-red-500/70 hover:text-red-500" title="Delete">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    } else {
        tableBody.style.display = 'none';
        noAlertsDiv.style.display = 'block';
    }
}

function displayAlertHistory(history) {
    const tableBody = document.getElementById('alertHistoryTable');
    const noHistoryDiv = document.getElementById('noAlertHistory');
    
    if (history && history.length > 0) {
        tableBody.style.display = '';
        noHistoryDiv.style.display = 'none';
        
        tableBody.innerHTML = history.map(item => `
            <tr class="border-b border-[#283339] opacity-70">
                <td class="p-4 font-medium">${item.symbol}</td>
                <td class="p-4">${formatCondition(item.condition_type)} - ${formatThreshold(item.threshold_value, item.condition_type)}</td>
                <td class="p-4 text-white/70">${formatDate(item.last_triggered)}</td>
                <td class="p-4">
                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-500/20 text-green-400">Triggered</span>
                </td>
            </tr>
        `).join('');
    } else {
        tableBody.style.display = 'none';
        noHistoryDiv.style.display = 'block';
    }
}

function createAlert() {
    const coinSymbol = document.getElementById('coinSearch').value.trim().toUpperCase();
    const condition = document.getElementById('alertCondition').value;
    const threshold = parseFloat(document.getElementById('thresholdValue').value);
    
    const notificationMethods = [];
    if (document.getElementById('notifyInApp').checked) notificationMethods.push('in-app');
    if (document.getElementById('notifyEmail').checked) notificationMethods.push('email');
    if (document.getElementById('notifyPush').checked) notificationMethods.push('push');
    
    if (!coinSymbol || !condition || isNaN(threshold) || notificationMethods.length === 0) {
        SolSignals.utils.showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    const alertData = {
        symbol: coinSymbol.includes('/') ? coinSymbol : coinSymbol + '/USDT',
        condition_type: condition,
        threshold_value: threshold,
        notification_method: notificationMethods.join(',')
    };
    
    // Show loading state
    const addBtn = document.getElementById('addAlertBtn');
    const originalText = addBtn.textContent;
    addBtn.textContent = 'Creating...';
    addBtn.disabled = true;
    
    fetch('/api/alerts/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(alertData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SolSignals.utils.showNotification('Alert created successfully!', 'success');
            // Clear form
            document.getElementById('coinSearch').value = '';
            document.getElementById('thresholdValue').value = '';
            document.getElementById('notifyInApp').checked = true;
            document.getElementById('notifyEmail').checked = false;
            document.getElementById('notifyPush').checked = false;
            // Reload alerts
            loadActiveAlerts();
        } else {
            SolSignals.utils.showNotification('Failed to create alert: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating alert:', error);
        SolSignals.utils.showNotification('Error creating alert: ' + error.message, 'error');
    })
    .finally(() => {
        // Restore button state
        addBtn.textContent = originalText;
        addBtn.disabled = false;
    });
}

function toggleAlert(alertId) {
    fetch(`/api/alerts/${alertId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SolSignals.utils.showNotification('Alert status updated', 'success');
            loadActiveAlerts();
        } else {
            SolSignals.utils.showNotification('Failed to update alert', 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling alert:', error);
        SolSignals.utils.showNotification('Error updating alert', 'error');
    });
}

function deleteAlert(alertId) {
    if (!confirm('Are you sure you want to delete this alert?')) {
        return;
    }
    
    fetch(`/api/alerts/${alertId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SolSignals.utils.showNotification('Alert deleted successfully', 'success');
            loadActiveAlerts();
        } else {
            SolSignals.utils.showNotification('Failed to delete alert', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting alert:', error);
        SolSignals.utils.showNotification('Error deleting alert', 'error');
    });
}

function formatCondition(conditionType) {
    const conditions = {
        'price_crosses_ema': 'Price crosses EMA',
        'price_above_ema': 'Price above EMA',
        'price_below_ema': 'Price below EMA',
        'volume_spike': 'Volume spike',
        'breakout_detected': 'Breakout detected',
        'rsi_oversold': 'RSI oversold',
        'rsi_overbought': 'RSI overbought'
    };
    return conditions[conditionType] || conditionType;
}

function formatThreshold(value, conditionType) {
    if (conditionType === 'volume_spike') {
        return value + '%';
    }
    return '$' + value;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function getNotificationIcons(methods) {
    const methodArray = methods.split(',');
    const icons = [];
    
    if (methodArray.includes('in-app')) {
        icons.push('<span class="material-symbols-outlined text-primary text-lg" title="In-App">notifications</span>');
    }
    if (methodArray.includes('email')) {
        icons.push('<span class="material-symbols-outlined text-primary text-lg" title="Email">mail</span>');
    }
    if (methodArray.includes('push')) {
        icons.push('<span class="material-symbols-outlined text-primary text-lg" title="Push">smartphone</span>');
    }
    
    return icons.join('');
}
</script>
{% endblock %}