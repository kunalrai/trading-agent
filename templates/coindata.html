<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>CoinDCX All Coins Scanner - 378 USDT Futures</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#00BFFF",
                        "background-light": "#f6f7f8",
                        "background-dark": "#1A1A2E",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00BFFF;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="layout-container flex h-full grow flex-col">
<div class="flex flex-1 justify-center py-5">
<div class="layout-content-container flex flex-col max-w-[1200px] flex-1">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#202038] px-10 py-3">
<div class="flex items-center gap-8">
<div class="flex items-center gap-4 text-white">
<div class="size-6 text-primary">
<svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path d="M24 45.8096C19.6865 45.8096 15.4698 44.5305 11.8832 42.134C8.29667 39.7376 5.50128 36.3314 3.85056 32.3462C2.19985 28.361 1.76794 23.9758 2.60947 19.7452C3.451 15.5145 5.52816 11.6284 8.57829 8.5783C11.6284 5.52817 15.5145 3.45101 19.7452 2.60948C23.9758 1.76795 28.361 2.19986 32.3462 3.85057C36.3314 5.50129 39.7376 8.29668 42.134 11.8833C44.5305 15.4698 45.8096 19.6865 45.8096 24L24 24L24 45.8096Z"></path>
</svg>
</div>
<h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">CoinDCX</h2>
</div>
</div>
<div class="flex gap-2">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-[#202038] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-white text-base">account_balance_wallet</span>
                                Wallet
                            </button>
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-[#202038] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-3">
<span class="material-symbols-outlined text-white text-base">notifications</span>
</button>
</div>
</header>
<div class="flex flex-wrap justify-between gap-3 p-4 px-10 items-center">
<div class="flex min-w-72 flex-col gap-3">
<p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">All 378 USDT Futures (15m)</p>
<p class="text-[#EAEAEA]/60 text-base font-normal leading-normal">
    <span id="last-updated">Loading...</span> | 
    <span id="total-coins">0</span> coins loaded
</p>
</div>
<button id="refresh-btn" class="flex items-center justify-center h-10 px-4 text-sm font-bold rounded-lg bg-primary text-white gap-2 hover:bg-primary/90 transition-colors">
<span class="material-symbols-outlined">refresh</span>
<span id="refresh-text">Refresh</span>
</button>
</div>
<div class="px-10 py-3">
<label class="flex flex-col min-w-40 h-12 w-full">
<div class="flex w-full flex-1 items-stretch rounded-lg h-full">
<div class="text-[#EAEAEA]/60 flex border-none bg-[#202038] items-center justify-center pl-4 rounded-l-lg border-r-0">
<span class="material-symbols-outlined">search</span>
</div>
<input id="search-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border-none bg-[#202038] focus:border-none h-full placeholder:text-[#EAEAEA]/60 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Search by symbol (e.g., BTC, ETH, SOL)" value=""/>
</div>
</label>
</div>
<div class="px-10 py-3 @container">
<div class="flex overflow-hidden rounded-lg border border-[#202038] bg-background-dark">
<table class="flex-1 w-full">
<thead>
<tr class="bg-[#1A1A2E]">
<th class="px-4 py-3 text-left text-white text-sm font-medium leading-normal cursor-pointer hover:bg-[#202038]" onclick="sortTable('symbol')">Symbol <span class="material-symbols-outlined text-sm align-middle">unfold_more</span></th>
<th class="px-4 py-3 text-left text-white text-sm font-medium leading-normal cursor-pointer hover:bg-[#202038]" onclick="sortTable('ema_50')">EMA50 <span class="material-symbols-outlined text-sm align-middle">unfold_more</span></th>
<th class="px-4 py-3 text-left text-white text-sm font-medium leading-normal cursor-pointer hover:bg-[#202038]" onclick="sortTable('current_price')">Current Price <span class="material-symbols-outlined text-sm align-middle">unfold_more</span></th>
<th class="px-4 py-3 text-left text-white text-sm font-medium leading-normal cursor-pointer hover:bg-[#202038]" onclick="sortTable('price_diff')">Difference <span class="material-symbols-outlined text-sm align-middle">unfold_more</span></th>
<th class="px-4 py-3 text-left text-white text-sm font-medium leading-normal cursor-pointer hover:bg-[#202038]" onclick="sortTable('volume_24h')">Volume 24h <span class="material-symbols-outlined text-sm align-middle">unfold_more</span></th>
</tr>
</thead>
<tbody id="coins-table-body">
<tr>
<td colspan="5" class="h-[200px] text-center text-white/60">
<div class="flex flex-col items-center justify-center gap-4">
<div class="loading-spinner"></div>
<span>Loading all 378 USDT futures data...</span>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="flex items-center justify-center p-4">
<a class="flex size-10 items-center justify-center" href="#">
<span class="material-symbols-outlined text-white">chevron_left</span>
</a>
<a class="text-sm font-bold leading-normal tracking-[0.015em] flex size-10 items-center justify-center text-white rounded-full bg-primary" href="#">1</a>
<a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-white rounded-full" href="#">2</a>
<a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-white rounded-full" href="#">3</a>
<span class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-white rounded-full">...</span>
<a class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-white rounded-full" href="#">19</a>
<a class="flex size-10 items-center justify-center" href="#">
<span class="material-symbols-outlined text-white">chevron_right</span>
</a>
</div>
</div>
</div>
</div>
</div>

<script>
// Global variables
let allCoinsData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 50;
let sortColumn = '';
let sortDirection = 'asc';
let isLoading = false;
let hasMoreData = true;
let currentOffset = 0;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    
    // Add event listeners
    document.getElementById('refresh-btn').addEventListener('click', refreshAllData);
    document.getElementById('search-input').addEventListener('input', handleSearch);
});

// Load initial batch of data
async function loadInitialData() {
    try {
        setRefreshState(true);
        showLoadingMessage("Loading first 50 coins...");
        
        const response = await fetch('/api/all-coins-data');
        const data = await response.json();
        
        if (data.status === 'success') {
            allCoinsData = data.data;
            filteredData = allCoinsData;
            currentOffset = data.batch_size || 50;
            hasMoreData = data.is_partial || false;
            
            updateUI(data);
            renderTable();
            updatePagination();
            
            // Start loading more data in background if there's more
            if (hasMoreData) {
                setTimeout(() => loadMoreDataInBackground(), 1000);
            }
        } else {
            showError(data.error || 'Failed to load data');
        }
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showError('Failed to connect to API');
    } finally {
        setRefreshState(false);
    }
}

// Load more data in background
async function loadMoreDataInBackground() {
    if (isLoading || !hasMoreData) return;
    
    try {
        isLoading = true;
        updateLoadingStatus(`Loading more coins... (${allCoinsData.length} loaded)`);
        
        const response = await fetch(`/api/all-coins-data-batch?offset=${currentOffset}&limit=50`);
        const data = await response.json();
        
        if (data.status === 'success' && data.data.length > 0) {
            // Add new data to existing data
            allCoinsData = [...allCoinsData, ...data.data];
            
            // Update filtered data if no search is active
            if (document.getElementById('search-input').value.trim() === '') {
                filteredData = allCoinsData;
                renderTable();
                updatePagination();
            }
            
            currentOffset = data.next_offset || currentOffset + 50;
            hasMoreData = data.has_more;
            
            updateUI({
                total_coins: allCoinsData.length,
                last_updated: data.last_updated
            });
            
            // Continue loading if there's more data
            if (hasMoreData) {
                setTimeout(() => loadMoreDataInBackground(), 2000); // 2 second delay between batches
            } else {
                updateLoadingStatus(`All ${allCoinsData.length} coins loaded!`);
                setTimeout(() => hideLoadingStatus(), 3000);
            }
        } else {
            hasMoreData = false;
        }
        
    } catch (error) {
        console.error('Error loading more data:', error);
        hasMoreData = false;
    } finally {
        isLoading = false;
    }
}

// Refresh all data
async function refreshAllData() {
    allCoinsData = [];
    filteredData = [];
    currentOffset = 0;
    hasMoreData = true;
    await loadInitialData();
}

// Show loading message
function showLoadingMessage(message) {
    const tbody = document.getElementById('coins-table-body');
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="h-[200px] text-center text-white/60">
                <div class="flex flex-col items-center justify-center gap-4">
                    <div class="loading-spinner"></div>
                    <span>${message}</span>
                </div>
            </td>
        </tr>
    `;
}

// Update loading status
function updateLoadingStatus(message) {
    const statusElement = document.getElementById('loading-status');
    if (statusElement) {
        statusElement.textContent = message;
    } else {
        // Create status element if it doesn't exist
        const statusDiv = document.createElement('div');
        statusDiv.id = 'loading-status';
        statusDiv.className = 'text-center text-white/60 text-sm py-2';
        statusDiv.textContent = message;
        
        const tableContainer = document.querySelector('.px-10.py-3.\\@container');
        if (tableContainer) {
            tableContainer.appendChild(statusDiv);
        }
    }
}

// Hide loading status
function hideLoadingStatus() {
    const statusElement = document.getElementById('loading-status');
    if (statusElement) {
        statusElement.remove();
    }
}

// Update UI elements
function updateUI(data) {
    document.getElementById('total-coins').textContent = data.total_coins;
    document.getElementById('last-updated').textContent = `Last updated: ${new Date(data.last_updated).toLocaleTimeString()}`;
}

// Set refresh button state
function setRefreshState(loading) {
    const btn = document.getElementById('refresh-btn');
    const text = document.getElementById('refresh-text');
    
    if (loading) {
        btn.disabled = true;
        btn.classList.add('opacity-50');
        text.textContent = 'Loading...';
    } else {
        btn.disabled = false;
        btn.classList.remove('opacity-50');
        text.textContent = 'Refresh';
    }
}

// Handle search
function handleSearch(event) {
    const searchTerm = event.target.value.toLowerCase();
    
    filteredData = allCoinsData.filter(coin => 
        coin.symbol.toLowerCase().includes(searchTerm)
    );
    
    currentPage = 1;
    renderTable();
    updatePagination();
}

// Sort table
function sortTable(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    filteredData.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Handle numeric columns
        if (typeof aVal === 'number' && typeof bVal === 'number') {
            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        // Handle string columns
        aVal = String(aVal).toLowerCase();
        bVal = String(bVal).toLowerCase();
        
        if (sortDirection === 'asc') {
            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
    });
    
    renderTable();
}

// Render table
function renderTable() {
    const tbody = document.getElementById('coins-table-body');
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="h-[100px] text-center text-white/60">
                    <span>No coins found</span>
                </td>
            </tr>
        `;
        return;
    }
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredData.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageData.map((coin, index) => {
        const rowClass = index % 2 === 0 ? '' : 'bg-[#202038]';
        const diffColor = coin.price_diff >= 0 ? '#28A745' : '#DC3545';
        const diffSign = coin.price_diff >= 0 ? '+' : '';
        
        return `
            <tr class="border-t border-t-[#202038] ${rowClass} hover:bg-[#202038]/50">
                <td class="h-[72px] px-4 py-2 text-white text-sm font-normal leading-normal">
                    ${coin.symbol}
                </td>
                <td class="h-[72px] px-4 py-2 text-[#EAEAEA] text-sm font-normal leading-normal">
                    ${formatPrice(coin.ema_50)}
                </td>
                <td class="h-[72px] px-4 py-2 text-[#EAEAEA] text-sm font-normal leading-normal">
                    ${formatPrice(coin.current_price)}
                </td>
                <td class="h-[72px] px-4 py-2 text-sm font-normal leading-normal" style="color: ${diffColor}">
                    ${diffSign}${formatPrice(coin.price_diff)} (${coin.diff_percentage >= 0 ? '+' : ''}${coin.diff_percentage}%)
                </td>
                <td class="h-[72px] px-4 py-2 text-[#EAEAEA] text-sm font-normal leading-normal">
                    ${formatVolume(coin.volume_24h)}
                </td>
            </tr>
        `;
    }).join('');
}

// Format price
function formatPrice(price) {
    if (price >= 1) {
        return price.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 8
        });
    } else {
        return price.toFixed(8);
    }
}

// Format volume
function formatVolume(volume) {
    if (volume >= 1000000) {
        return (volume / 1000000).toFixed(2) + 'M';
    } else if (volume >= 1000) {
        return (volume / 1000).toFixed(2) + 'K';
    } else {
        return volume.toLocaleString();
    }
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    // For now, we'll handle pagination simply
    // Future enhancement: Add proper pagination controls
}

// Show error
function showError(message) {
    const tbody = document.getElementById('coins-table-body');
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="h-[100px] text-center text-red-400">
                <span>Error: ${message}</span>
            </td>
        </tr>
    `;
}
</script>

</body></html>